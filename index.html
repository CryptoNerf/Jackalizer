<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackalizer - –ü–∏–∫—Å–µ–ª–∏–∑–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <h1 class="main-title">Jackalizer</h1>

    <div class="main-container">
        <div class="panel left-panel">
            <div class="drop-zone" id="dropZone">
                <p>your photo</p>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <canvas id="canvas"></canvas>
        </div>

        <div class="panel right-panel">
            <div class="control-group">
                <label for="pixelSize">–°—Ç–µ–ø–µ–Ω—å –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏–∏: <span id="pixelSizeValue">62</span></label>
                <input type="range" id="pixelSize" min="2" max="100" value="62">
            </div>

            <div class="control-group hidden" id="brushControls">
                <label>–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è:</label>
                <div class="button-group">
                    <button id="brushBtn" class="mode-btn">üñåÔ∏è –ö–∏—Å—Ç—å</button>
                    <button id="eraserBtn" class="mode-btn">üßπ –õ–∞—Å—Ç–∏–∫</button>
                </div>
                <label for="brushSize">–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏: <span id="brushSizeValue">30</span></label>
                <input type="range" id="brushSize" min="5" max="100" value="30">
                <button id="clearMaskBtn" class="secondary-btn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                <button id="applyFullBtn" class="secondary-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º—É</button>
            </div>

            <div class="buttons hidden" id="buttons">
                <button id="downloadBtn">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
                <button id="resetBtn">–ù–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
            </div>
        </div>
    </div>

    <footer>
        Copyright 2025 Emile Alexanyan
    </footer>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const buttons = document.getElementById('buttons');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const pixelSizeSlider = document.getElementById('pixelSize');
        const pixelSizeValue = document.getElementById('pixelSizeValue');
        const brushControls = document.getElementById('brushControls');
        const brushBtn = document.getElementById('brushBtn');
        const eraserBtn = document.getElementById('eraserBtn');
        const brushSizeSlider = document.getElementById('brushSize');
        const brushSizeValue = document.getElementById('brushSizeValue');
        const clearMaskBtn = document.getElementById('clearMaskBtn');
        const applyFullBtn = document.getElementById('applyFullBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');

        let currentImage = null;
        let originalImageData = null;
        let pixelatedImageData = null;
        let maskCanvas = null;
        let maskCtx = null;
        let isDrawing = false;
        let brushMode = 'brush'; // 'brush' or 'eraser'
        let brushSize = 30;

        // Drag & Drop
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadImage(file);
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    setupCanvas(img);
                    showControls();
                    applyPixelation();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–Ω–≤–∞—Å–∞
        function setupCanvas(img) {
            const maxWidth = 450;
            const scale = Math.min(1, maxWidth / img.width);
            const width = img.width * scale;
            const height = img.height * scale;

            canvas.width = width;
            canvas.height = height;

            ctx.drawImage(img, 0, 0, width, height);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            originalImageData = ctx.getImageData(0, 0, width, height);

            // –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫—É –¥–ª—è –≤—ã–±–æ—Ä–æ—á–Ω–æ–π –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏–∏
            maskCanvas = document.createElement('canvas');
            maskCanvas.width = width;
            maskCanvas.height = height;
            maskCtx = maskCanvas.getContext('2d');
            maskCtx.fillStyle = 'black';
            maskCtx.fillRect(0, 0, width, height);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function showControls() {
            dropZone.classList.add('hidden');
            canvas.style.display = 'block';
            brushControls.classList.remove('hidden');
            buttons.classList.remove('hidden');
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏—è —Å –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        function applyPixelation() {
            if (!currentImage || !originalImageData) return;

            const pixelSize = parseInt(pixelSizeSlider.value);
            const width = canvas.width;
            const height = canvas.height;

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
            ctx.putImageData(originalImageData, 0, 0);

            // –ï—Å–ª–∏ —Å—Ç–µ–ø–µ–Ω—å –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏–∏ = 2 (–º–∏–Ω–∏–º—É–º), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
            if (pixelSize <= 2) {
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏–∏
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            // –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç–µ–ø–µ–Ω–∏ –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏–∏
            const smallWidth = Math.ceil(width / pixelSize);
            const smallHeight = Math.ceil(height / pixelSize);

            tempCanvas.width = smallWidth;
            tempCanvas.height = smallHeight;

            // –û—Ç–∫–ª—é—á–∞–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è —á–µ—Ç–∫–∏—Ö –ø–∏–∫—Å–µ–ª–µ–π
            tempCtx.imageSmoothingEnabled = false;

            // –†–∏—Å—É–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
            tempCtx.drawImage(canvas, 0, 0, width, height, 0, 0, smallWidth, smallHeight);

            // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –ø–∏–∫—Å–µ–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
            const pixelatedCanvas = document.createElement('canvas');
            const pixelatedCtx = pixelatedCanvas.getContext('2d');
            pixelatedCanvas.width = width;
            pixelatedCanvas.height = height;
            pixelatedCtx.imageSmoothingEnabled = false;

            // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
            pixelatedCtx.drawImage(tempCanvas, 0, 0, smallWidth, smallHeight, 0, 0, width, height);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∏–∫—Å–µ–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
            pixelatedImageData = pixelatedCtx.getImageData(0, 0, width, height);

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É
            applyMask();
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞—Å–∫–∏ –¥–ª—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –∏ –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏–∏
        function applyMask() {
            if (!originalImageData || !pixelatedImageData || !maskCanvas) return;

            const width = canvas.width;
            const height = canvas.height;

            const original = originalImageData.data;
            const pixelated = pixelatedImageData.data;
            const maskData = maskCtx.getImageData(0, 0, width, height).data;
            const result = ctx.createImageData(width, height);
            const resultData = result.data;

            for (let i = 0; i < resultData.length; i += 4) {
                const maskValue = maskData[i] / 255; // 0 = –æ—Ä–∏–≥–∏–Ω–∞–ª, 1 = –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏—è

                resultData[i] = original[i] * (1 - maskValue) + pixelated[i] * maskValue;
                resultData[i + 1] = original[i + 1] * (1 - maskValue) + pixelated[i + 1] * maskValue;
                resultData[i + 2] = original[i + 2] * (1 - maskValue) + pixelated[i + 2] * maskValue;
                resultData[i + 3] = original[i + 3];
            }

            ctx.putImageData(result, 0, 0);
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –º–∞—Å–∫–∏
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function drawOnMask(x, y) {
            if (!maskCtx) return;

            maskCtx.fillStyle = brushMode === 'brush' ? 'white' : 'black';
            maskCtx.beginPath();
            maskCtx.arc(x, y, brushSize, 0, Math.PI * 2);
            maskCtx.fill();

            applyMask();
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!currentImage) return;
            isDrawing = true;
            const coords = getCanvasCoordinates(e);
            drawOnMask(coords.x, coords.y);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing || !currentImage) return;
            const coords = getCanvasCoordinates(e);
            drawOnMask(coords.x, coords.y);
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
        });

        // Touch events –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        canvas.addEventListener('touchstart', (e) => {
            if (!currentImage) return;
            e.preventDefault();
            isDrawing = true;
            const touch = e.touches[0];
            const coords = getCanvasCoordinates(touch);
            drawOnMask(coords.x, coords.y);
        });

        canvas.addEventListener('touchmove', (e) => {
            if (!isDrawing || !currentImage) return;
            e.preventDefault();
            const touch = e.touches[0];
            const coords = getCanvasCoordinates(touch);
            drawOnMask(coords.x, coords.y);
        });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            isDrawing = false;
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∏—Å—Ç—å—é
        brushBtn.addEventListener('click', () => {
            brushMode = 'brush';
            brushBtn.classList.add('active');
            eraserBtn.classList.remove('active');
        });

        eraserBtn.addEventListener('click', () => {
            brushMode = 'eraser';
            eraserBtn.classList.add('active');
            brushBtn.classList.remove('active');
        });

        brushSizeSlider.addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value);
            brushSizeValue.textContent = brushSize;
        });

        clearMaskBtn.addEventListener('click', () => {
            if (!maskCtx) return;
            maskCtx.fillStyle = 'black';
            maskCtx.fillRect(0, 0, canvas.width, canvas.height);
            applyMask();
        });

        applyFullBtn.addEventListener('click', () => {
            if (!maskCtx) return;
            maskCtx.fillStyle = 'white';
            maskCtx.fillRect(0, 0, canvas.width, canvas.height);
            applyMask();
        });

        // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        pixelSizeSlider.addEventListener('input', (e) => {
            pixelSizeValue.textContent = e.target.value;
            applyPixelation();
        });

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'pixelated-image.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        // –°–±—Ä–æ—Å
        resetBtn.addEventListener('click', () => {
            currentImage = null;
            originalImageData = null;
            pixelatedImageData = null;
            maskCanvas = null;
            maskCtx = null;
            fileInput.value = '';
            pixelSizeSlider.value = 62;
            pixelSizeValue.textContent = '62';
            brushSize = 30;
            brushSizeValue.textContent = '30';
            brushMode = 'brush';
            brushBtn.classList.remove('active');
            eraserBtn.classList.remove('active');
            dropZone.classList.remove('hidden');
            canvas.style.display = 'none';
            brushControls.classList.add('hidden');
            buttons.classList.add('hidden');
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –∫–∏—Å—Ç–∏
        brushBtn.classList.add('active');
    </script>
</body>
</html>