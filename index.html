<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackalizer</title>
    <meta property="og:image" content="img/preview.jpg">
    <meta property="og:title" content="Jackalizer">
    <meta property="og:description" content="Image pixelation tool">
    <link rel="icon" type="image/png" href="img/favicon.png">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <h1 class="main-title">Jackalizer</h1>
    <img class="header-image" src="img/jackalizer2.png" alt="">
    <div class="main-container" id="mainContainer">
        <div class="panel left-panel">
            <div class="drop-zone" id="dropZone">
                <p>your photo</p>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <canvas id="canvas"></canvas>
        </div>

        <div class="panel right-panel hidden" id="rightPanel">
            <div class="control-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç:</label>
                <div class="button-group">
                    <button id="pixelEffectBtn" class="mode-btn active">üé® –ü–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏—è</button>
                    <button id="blurEffectBtn" class="mode-btn">üå´Ô∏è –ë–ª—é—Ä</button>
                </div>
            </div>

            <div class="control-group" id="pixelControls">
                <label for="pixelSize">–°—Ç–µ–ø–µ–Ω—å –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏–∏: <span id="pixelSizeValue">62</span></label>
                <input type="range" id="pixelSize" min="2" max="100" value="62">
            </div>

            <div class="control-group hidden" id="blurControls">
                <label for="blurSize">–°–∏–ª–∞ –±–ª—é—Ä–∞: <span id="blurSizeValue">10</span></label>
                <input type="range" id="blurSize" min="1" max="50" value="10">
            </div>

            <div class="control-group hidden" id="brushControls">
                <label>–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è:</label>
                <div class="button-group">
                    <button id="brushBtn" class="mode-btn">üñåÔ∏è –ö–∏—Å—Ç—å</button>
                    <button id="eraserBtn" class="mode-btn">üßπ –õ–∞—Å—Ç–∏–∫</button>
                </div>
                <label for="brushSize">–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏: <span id="brushSizeValue">30</span></label>
                <input type="range" id="brushSize" min="5" max="100" value="30">
                <button id="clearMaskBtn" class="secondary-btn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                <button id="applyFullBtn" class="secondary-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º—É</button>
            </div>

            <div class="buttons hidden" id="buttons">
                <button id="downloadBtn">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
                <button id="resetBtn">–ù–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
            </div>
        </div>
    </div>

    <footer>
        <a href="https://cryptonerf.github.io/portfolio/" target="_blank">Copyright 2025 √âmile Alexanyan</a>
    </footer>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const mainContainer = document.getElementById('mainContainer');
        const rightPanel = document.getElementById('rightPanel');
        const buttons = document.getElementById('buttons');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const pixelEffectBtn = document.getElementById('pixelEffectBtn');
        const blurEffectBtn = document.getElementById('blurEffectBtn');
        const pixelControls = document.getElementById('pixelControls');
        const blurControls = document.getElementById('blurControls');
        const pixelSizeSlider = document.getElementById('pixelSize');
        const pixelSizeValue = document.getElementById('pixelSizeValue');
        const blurSizeSlider = document.getElementById('blurSize');
        const blurSizeValue = document.getElementById('blurSizeValue');
        const brushControls = document.getElementById('brushControls');
        const brushBtn = document.getElementById('brushBtn');
        const eraserBtn = document.getElementById('eraserBtn');
        const brushSizeSlider = document.getElementById('brushSize');
        const brushSizeValue = document.getElementById('brushSizeValue');
        const clearMaskBtn = document.getElementById('clearMaskBtn');
        const applyFullBtn = document.getElementById('applyFullBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');

        let currentImage = null;
        let originalImageData = null;
        let pixelatedImageData = null;
        let blurredImageData = null;
        let pixelMaskCanvas = null;
        let pixelMaskCtx = null;
        let blurMaskCanvas = null;
        let blurMaskCtx = null;
        let isDrawing = false;
        let brushMode = 'brush'; // 'brush' or 'eraser'
        let brushSize = 30;
        let currentEffect = 'pixelate'; // 'pixelate' or 'blur'
        let scaleRatio = 1; // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –º–µ–∂–¥—É –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–º —Ä–∞–∑–º–µ—Ä–æ–º

        // Drag & Drop
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadImage(file);
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    setupCanvas(img);
                    showControls();
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–±–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
                    applyPixelation();
                    applyBlur();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–Ω–≤–∞—Å–∞
        function setupCanvas(img) {
            const maxWidth = 450;
            scaleRatio = Math.min(1, maxWidth / img.width);
            const width = img.width * scaleRatio;
            const height = img.height * scaleRatio;

            canvas.width = width;
            canvas.height = height;

            ctx.drawImage(img, 0, 0, width, height);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            originalImageData = ctx.getImageData(0, 0, width, height);

            // –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫—É –¥–ª—è –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏–∏
            pixelMaskCanvas = document.createElement('canvas');
            pixelMaskCanvas.width = width;
            pixelMaskCanvas.height = height;
            pixelMaskCtx = pixelMaskCanvas.getContext('2d');
            pixelMaskCtx.fillStyle = 'black';
            pixelMaskCtx.fillRect(0, 0, width, height);

            // –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫—É –¥–ª—è –±–ª—é—Ä–∞
            blurMaskCanvas = document.createElement('canvas');
            blurMaskCanvas.width = width;
            blurMaskCanvas.height = height;
            blurMaskCtx = blurMaskCanvas.getContext('2d');
            blurMaskCtx.fillStyle = 'black';
            blurMaskCtx.fillRect(0, 0, width, height);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function showControls() {
            dropZone.classList.add('hidden');
            canvas.style.display = 'block';
            rightPanel.classList.remove('hidden');
            mainContainer.classList.add('two-panels');
            brushControls.classList.remove('hidden');
            buttons.classList.remove('hidden');
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏—è —Å –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        function applyPixelation() {
            if (!currentImage || !originalImageData) return;

            const pixelSize = parseInt(pixelSizeSlider.value);
            const width = canvas.width;
            const height = canvas.height;

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
            ctx.putImageData(originalImageData, 0, 0);

            // –ï—Å–ª–∏ —Å—Ç–µ–ø–µ–Ω—å –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏–∏ = 2 (–º–∏–Ω–∏–º—É–º), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
            if (pixelSize <= 2) {
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏–∏
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            // –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç–µ–ø–µ–Ω–∏ –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏–∏
            const smallWidth = Math.ceil(width / pixelSize);
            const smallHeight = Math.ceil(height / pixelSize);

            tempCanvas.width = smallWidth;
            tempCanvas.height = smallHeight;

            // –û—Ç–∫–ª—é—á–∞–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è —á–µ—Ç–∫–∏—Ö –ø–∏–∫—Å–µ–ª–µ–π
            tempCtx.imageSmoothingEnabled = false;

            // –†–∏—Å—É–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
            tempCtx.drawImage(canvas, 0, 0, width, height, 0, 0, smallWidth, smallHeight);

            // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –ø–∏–∫—Å–µ–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
            const pixelatedCanvas = document.createElement('canvas');
            const pixelatedCtx = pixelatedCanvas.getContext('2d');
            pixelatedCanvas.width = width;
            pixelatedCanvas.height = height;
            pixelatedCtx.imageSmoothingEnabled = false;

            // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
            pixelatedCtx.drawImage(tempCanvas, 0, 0, smallWidth, smallHeight, 0, 0, width, height);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∏–∫—Å–µ–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
            pixelatedImageData = pixelatedCtx.getImageData(0, 0, width, height);

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É
            applyMask();
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–ª—é—Ä–∞ —Å –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        function applyBlur() {
            if (!currentImage || !originalImageData) return;

            const blurSize = parseInt(blurSizeSlider.value);
            const width = canvas.width;
            const height = canvas.height;

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
            ctx.putImageData(originalImageData, 0, 0);

            // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –±–ª—é—Ä–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
            if (blurSize <= 1) {
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;
            tempCtx.putImageData(originalImageData, 0, 0);

            // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è —Ä–∞–∑–º—ã—Ç–æ–π –≤–µ—Ä—Å–∏–∏
            const blurredCanvas = document.createElement('canvas');
            const blurredCtx = blurredCanvas.getContext('2d');
            blurredCanvas.width = width;
            blurredCanvas.height = height;

            // –ü—Ä–∏–º–µ–Ω—è–µ–º CSS filter –¥–ª—è –±–ª—é—Ä–∞, —Ä–∏—Å—É—è –∏–∑ tempCanvas
            blurredCtx.filter = `blur(${blurSize}px)`;
            blurredCtx.drawImage(tempCanvas, 0, 0);
            blurredCtx.filter = 'none';

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑–º—ã—Ç—É—é –≤–µ—Ä—Å–∏—é
            blurredImageData = blurredCtx.getImageData(0, 0, width, height);

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É
            applyMask();
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞—Å–∫–∏ –¥–ª—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        function applyMask() {
            if (!originalImageData || !pixelMaskCanvas || !blurMaskCanvas) return;
            if (!pixelatedImageData || !blurredImageData) return;

            const width = canvas.width;
            const height = canvas.height;

            const original = originalImageData.data;
            const pixelated = pixelatedImageData.data;
            const blurred = blurredImageData.data;
            const pixelMaskData = pixelMaskCtx.getImageData(0, 0, width, height).data;
            const blurMaskData = blurMaskCtx.getImageData(0, 0, width, height).data;

            const result = ctx.createImageData(width, height);
            const resultData = result.data;

            for (let i = 0; i < resultData.length; i += 4) {
                const pixelMaskValue = pixelMaskData[i] / 255; // 0 = –æ—Ä–∏–≥–∏–Ω–∞–ª, 1 = –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏—è
                const blurMaskValue = blurMaskData[i] / 255; // 0 = –æ—Ä–∏–≥–∏–Ω–∞–ª, 1 = –±–ª—é—Ä

                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏—é
                let r = original[i] * (1 - pixelMaskValue) + pixelated[i] * pixelMaskValue;
                let g = original[i + 1] * (1 - pixelMaskValue) + pixelated[i + 1] * pixelMaskValue;
                let b = original[i + 2] * (1 - pixelMaskValue) + pixelated[i + 2] * pixelMaskValue;

                // –ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω—è–µ–º –±–ª—é—Ä –ø–æ–≤–µ—Ä—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                r = r * (1 - blurMaskValue) + blurred[i] * blurMaskValue;
                g = g * (1 - blurMaskValue) + blurred[i + 1] * blurMaskValue;
                b = b * (1 - blurMaskValue) + blurred[i + 2] * blurMaskValue;

                resultData[i] = r;
                resultData[i + 1] = g;
                resultData[i + 2] = b;
                resultData[i + 3] = original[i + 3];
            }

            ctx.putImageData(result, 0, 0);
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –º–∞—Å–∫–∏
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function drawOnMask(x, y) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞ –∫–∞–∫–æ–π –º–∞—Å–∫–µ —Ä–∏—Å–æ–≤–∞—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
            const maskCtx = currentEffect === 'pixelate' ? pixelMaskCtx : blurMaskCtx;
            if (!maskCtx) return;

            maskCtx.fillStyle = brushMode === 'brush' ? 'white' : 'black';
            maskCtx.beginPath();
            maskCtx.arc(x, y, brushSize, 0, Math.PI * 2);
            maskCtx.fill();

            applyMask();
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!currentImage) return;
            isDrawing = true;
            const coords = getCanvasCoordinates(e);
            drawOnMask(coords.x, coords.y);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing || !currentImage) return;
            const coords = getCanvasCoordinates(e);
            drawOnMask(coords.x, coords.y);
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
        });

        // Touch events –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        canvas.addEventListener('touchstart', (e) => {
            if (!currentImage) return;
            e.preventDefault();
            isDrawing = true;
            const touch = e.touches[0];
            const coords = getCanvasCoordinates(touch);
            drawOnMask(coords.x, coords.y);
        });

        canvas.addEventListener('touchmove', (e) => {
            if (!isDrawing || !currentImage) return;
            e.preventDefault();
            const touch = e.touches[0];
            const coords = getCanvasCoordinates(touch);
            drawOnMask(coords.x, coords.y);
        });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            isDrawing = false;
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∏—Å—Ç—å—é
        brushBtn.addEventListener('click', () => {
            brushMode = 'brush';
            brushBtn.classList.add('active');
            eraserBtn.classList.remove('active');
        });

        eraserBtn.addEventListener('click', () => {
            brushMode = 'eraser';
            eraserBtn.classList.add('active');
            brushBtn.classList.remove('active');
        });

        brushSizeSlider.addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value);
            brushSizeValue.textContent = brushSize;
        });

        clearMaskBtn.addEventListener('click', () => {
            // –û—á–∏—â–∞–µ–º –º–∞—Å–∫—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
            const maskCtx = currentEffect === 'pixelate' ? pixelMaskCtx : blurMaskCtx;
            if (!maskCtx) return;
            maskCtx.fillStyle = 'black';
            maskCtx.fillRect(0, 0, canvas.width, canvas.height);
            applyMask();
        });

        applyFullBtn.addEventListener('click', () => {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É –∫–æ –≤—Å–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
            const maskCtx = currentEffect === 'pixelate' ? pixelMaskCtx : blurMaskCtx;
            if (!maskCtx) return;
            maskCtx.fillStyle = 'white';
            maskCtx.fillRect(0, 0, canvas.width, canvas.height);
            applyMask();
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        pixelEffectBtn.addEventListener('click', () => {
            currentEffect = 'pixelate';
            pixelEffectBtn.classList.add('active');
            blurEffectBtn.classList.remove('active');
            pixelControls.classList.remove('hidden');
            blurControls.classList.add('hidden');
        });

        blurEffectBtn.addEventListener('click', () => {
            currentEffect = 'blur';
            blurEffectBtn.classList.add('active');
            pixelEffectBtn.classList.remove('active');
            blurControls.classList.remove('hidden');
            pixelControls.classList.add('hidden');
        });

        // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        pixelSizeSlider.addEventListener('input', (e) => {
            pixelSizeValue.textContent = e.target.value;
            applyPixelation();
        });

        blurSizeSlider.addEventListener('input', (e) => {
            blurSizeValue.textContent = e.target.value;
            applyBlur();
        });

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
        downloadBtn.addEventListener('click', () => {
            if (!currentImage) return;

            const originalWidth = currentImage.width;
            const originalHeight = currentImage.height;

            // –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫–∏ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
            const exportPixelMaskCanvas = document.createElement('canvas');
            const exportPixelMaskCtx = exportPixelMaskCanvas.getContext('2d');
            exportPixelMaskCanvas.width = originalWidth;
            exportPixelMaskCanvas.height = originalHeight;
            exportPixelMaskCtx.imageSmoothingEnabled = true;
            exportPixelMaskCtx.drawImage(pixelMaskCanvas, 0, 0, canvas.width, canvas.height,
                                         0, 0, originalWidth, originalHeight);

            const exportBlurMaskCanvas = document.createElement('canvas');
            const exportBlurMaskCtx = exportBlurMaskCanvas.getContext('2d');
            exportBlurMaskCanvas.width = originalWidth;
            exportBlurMaskCanvas.height = originalHeight;
            exportBlurMaskCtx.imageSmoothingEnabled = true;
            exportBlurMaskCtx.drawImage(blurMaskCanvas, 0, 0, canvas.width, canvas.height,
                                        0, 0, originalWidth, originalHeight);

            // –°–æ–∑–¥–∞–µ–º –ø–∏–∫—Å–µ–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
            const pixelSize = parseInt(pixelSizeSlider.value);
            const scaledPixelSize = pixelSize / scaleRatio;
            const smallWidth = Math.ceil(originalWidth / scaledPixelSize);
            const smallHeight = Math.ceil(originalHeight / scaledPixelSize);

            const tempCanvas1 = document.createElement('canvas');
            const tempCtx1 = tempCanvas1.getContext('2d');
            tempCanvas1.width = smallWidth;
            tempCanvas1.height = smallHeight;
            tempCtx1.imageSmoothingEnabled = true;
            tempCtx1.drawImage(currentImage, 0, 0, originalWidth, originalHeight,
                             0, 0, smallWidth, smallHeight);

            const pixelatedCanvas = document.createElement('canvas');
            const pixelatedCtx = pixelatedCanvas.getContext('2d');
            pixelatedCanvas.width = originalWidth;
            pixelatedCanvas.height = originalHeight;
            pixelatedCtx.imageSmoothingEnabled = false;
            pixelatedCtx.drawImage(tempCanvas1, 0, 0, smallWidth, smallHeight,
                                  0, 0, originalWidth, originalHeight);

            // –°–æ–∑–¥–∞–µ–º —Ä–∞–∑–º—ã—Ç—É—é –≤–µ—Ä—Å–∏—é –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
            const blurSize = parseInt(blurSizeSlider.value);
            const scaledBlurSize = blurSize / scaleRatio;

            const tempCanvas2 = document.createElement('canvas');
            const tempCtx2 = tempCanvas2.getContext('2d');
            tempCanvas2.width = originalWidth;
            tempCanvas2.height = originalHeight;
            tempCtx2.drawImage(currentImage, 0, 0, originalWidth, originalHeight);

            const blurredCanvas = document.createElement('canvas');
            const blurredCtx = blurredCanvas.getContext('2d');
            blurredCanvas.width = originalWidth;
            blurredCanvas.height = originalHeight;
            blurredCtx.filter = `blur(${scaledBlurSize}px)`;
            blurredCtx.drawImage(tempCanvas2, 0, 0);
            blurredCtx.filter = 'none';

            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
            const exportCanvas = document.createElement('canvas');
            const exportCtx = exportCanvas.getContext('2d');
            exportCanvas.width = originalWidth;
            exportCanvas.height = originalHeight;
            exportCtx.drawImage(currentImage, 0, 0, originalWidth, originalHeight);

            const originalData = exportCtx.getImageData(0, 0, originalWidth, originalHeight);
            const pixelatedData = pixelatedCtx.getImageData(0, 0, originalWidth, originalHeight);
            const blurredData = blurredCtx.getImageData(0, 0, originalWidth, originalHeight);
            const pixelMaskData = exportPixelMaskCtx.getImageData(0, 0, originalWidth, originalHeight);
            const blurMaskData = exportBlurMaskCtx.getImageData(0, 0, originalWidth, originalHeight);

            const original = originalData.data;
            const pixelated = pixelatedData.data;
            const blurred = blurredData.data;
            const pixelMask = pixelMaskData.data;
            const blurMask = blurMaskData.data;

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å –æ–±–µ–∏–º–∏ –º–∞—Å–∫–∞–º–∏
            for (let i = 0; i < original.length; i += 4) {
                const pixelMaskValue = pixelMask[i] / 255;
                const blurMaskValue = blurMask[i] / 255;

                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–∏–∫—Å–µ–ª–∏–∑–∞—Ü–∏—é
                let r = original[i] * (1 - pixelMaskValue) + pixelated[i] * pixelMaskValue;
                let g = original[i + 1] * (1 - pixelMaskValue) + pixelated[i + 1] * pixelMaskValue;
                let b = original[i + 2] * (1 - pixelMaskValue) + pixelated[i + 2] * pixelMaskValue;

                // –ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω—è–µ–º –±–ª—é—Ä –ø–æ–≤–µ—Ä—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                r = r * (1 - blurMaskValue) + blurred[i] * blurMaskValue;
                g = g * (1 - blurMaskValue) + blurred[i + 1] * blurMaskValue;
                b = b * (1 - blurMaskValue) + blurred[i + 2] * blurMaskValue;

                originalData.data[i] = Math.round(r);
                originalData.data[i + 1] = Math.round(g);
                originalData.data[i + 2] = Math.round(b);
            }

            exportCtx.putImageData(originalData, 0, 0);

            // –°–∫–∞—á–∏–≤–∞–µ–º
            const link = document.createElement('a');
            link.download = 'jackalizer-result.png';
            link.href = exportCanvas.toDataURL('image/png');
            link.click();
        });

        // –°–±—Ä–æ—Å
        resetBtn.addEventListener('click', () => {
            currentImage = null;
            originalImageData = null;
            pixelatedImageData = null;
            blurredImageData = null;
            pixelMaskCanvas = null;
            pixelMaskCtx = null;
            blurMaskCanvas = null;
            blurMaskCtx = null;
            currentEffect = 'pixelate';
            fileInput.value = '';
            pixelSizeSlider.value = 62;
            pixelSizeValue.textContent = '62';
            blurSizeSlider.value = 10;
            blurSizeValue.textContent = '10';
            brushSize = 30;
            brushSizeValue.textContent = '30';
            brushMode = 'brush';
            brushBtn.classList.remove('active');
            eraserBtn.classList.remove('active');
            pixelEffectBtn.classList.add('active');
            blurEffectBtn.classList.remove('active');
            pixelControls.classList.remove('hidden');
            blurControls.classList.add('hidden');
            dropZone.classList.remove('hidden');
            canvas.style.display = 'none';
            rightPanel.classList.add('hidden');
            mainContainer.classList.remove('two-panels');
            brushControls.classList.add('hidden');
            buttons.classList.add('hidden');
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –∫–∏—Å—Ç–∏
        brushBtn.classList.add('active');
    </script>
</body>
</html>